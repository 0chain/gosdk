<!DOCTYPE html>
<head>
  <script src="https://cdn.jsdelivr.net/gh/herumi/bls-wasm@v1.0.0/browser/bls.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/golang/go@go1.18.5/misc/wasm/wasm_exec.js"></script>

  <script src="wasm.js"></script>

  <script>

    const networkConfig = {
      chainId: '0afc093ffb509f059c55478bc1a60351cef7b4e9c008a53a6cc8241ca8617dfe',
      signatureScheme: 'bls0chain',
      minConfirmation: 50,
      minSubmit: 50,
      confirmationChainLength: 3,
    }
    const blockWorker =  `https://demo.0chain.net/dns`
    const config = [
      networkConfig.chainId,
      blockWorker,
      networkConfig.signatureScheme,
      networkConfig.minConfirmation,
      networkConfig.minSubmit,
      networkConfig.confirmationChainLength
    ]

    const clientID = '79ff82def0235b16cffecd1c90851975cd7c961a2c6ced6cc6c0bf89a44a4a70'
    const publicKey = '6ce9c9e17e3b9b7a0c293e0c6523c5dbede55d1831c646e1acdcf5194bb0b40f38db1d3a315754cf7f6a501b4c4be8d4444471d4de420762d5e05ef91790f8a1';
    const privateKey = '8450a619fc89e57e698d270c9abaa843d689cc37ae161953d73ab74881c1d820'

    const bls = window.bls
    let goWasm ;
    createWasm().then(async wasm => {
      await wasm.sdk.init(...config)
      await bls.init(bls.BN254)
      await wasm.setWallet(bls, clientID,privateKey, publicKey)

      goWasm = wasm
    })


   
    let allocations = []
    let files = []

    const bindAllocations = ()=> document.getElementById('listAllocations').innerHTML = allocations.map(a=> `<input type="radio"  name="selectedAllocation" value="${a.id}"><label for="${a.id}">${a.id}</label><br>`).join("")
    const bindFiles = () => document.getElementById('listFiles').innerHTML = files.map(f=>`<input type="radio" name="selectedFile" value="${f.path}"><label for="${f.path}">${f.path}</label><br>`).join("")
    const readBytes = file => new Promise(resolve => {
    const reader = new FileReader()
    reader.onloadend = () => {
      resolve(new Uint8Array(reader.result))
    }
    reader.readAsArrayBuffer(file)
  })

    document.addEventListener("DOMContentLoaded", ()=> {

      document.getElementById('btnCreateAllocation').onclick = async ()=> {
        const allocation = await goWasm.sdk.createAllocation()
        allocations.push(allocation)
        bindAllocations()
      }

      document.getElementById('btnListAllocations').onclick = async ()=> {
        allocations = await goWasm.sdk.listAllocations()
        bindAllocations()
      }


      document.getElementById('btnListFiles').onclick = async () => {
        const allocationId = getSelectedAllocation()

        const { list =[] } = await  goWasm.sdk.listObjects(allocationId, '/')
        files = list || []
        bindFiles()
      }

      document.getElementById('btnUploadFile').onclick = async()=> {
        const { files } = document.getElementById('inputSelectedFile')
        if (files && files.length>0){
          const fileBytes = await readBytes(files[0])
          const allocationId = getSelectedAllocation()

          //allocationID, remotePath string, fileBytes, thumbnailBytes []byte, encrypt, commit bool, isLiveUpload, isSyncUpload bool, isUpdate, isRepair bool
          await goWasm.sdk.upload(
            allocationId,`/${files[0].name}`,
            fileBytes,
            null,
            false,false,false,false,false,false)

        }
      }
      
    })
    
    

    const getSelectedAllocation = ()=>  [...document.getElementsByName('selectedAllocation')].filter(it=>it.checked).map(it=>it.value).find(it=>it != "");


  </script>

</head>

<body>

  <fieldset >
    <legend>Allocations</legend>
   
    <span>
      <button id="btnListAllocations">List</button>
      <button id="btnCreateAllocation" >Create</button>
    </span>
    
    <br>


    <div id="listAllocations">
    </div>


  </fieldset>



  <fieldset >
    <legend>Files</legend>
    <button id="btnListFiles">List</button>
    <span ><input id="inputSelectedFile" type="file"/> <button id="btnUploadFile">Upload</button> </span>
    <br>
    <div id="listFiles">
    </div>

  </fieldset>
</body>